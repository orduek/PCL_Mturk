---
title: "Questionnaire Analysis"
author: "Or Duek & Tobias R. Spiller"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: yes

---


```{r, results='hide',  message=FALSE, warning=FALSE, include=FALSE}
# load libraries
require(tidyverse)
require(dplyr)
require(ggplot2)
require(bootnet)
require(qgraph)
require(psychonetrics)

# map
require(sf)
require(mapview)

# tables
require(gtsummary)
# xls
library(readxl)
```

# Analysing Prolific Data

```{r}
# read data
df <- read.csv('Prolific_trauma-exp_only_PCL-V_Randomization.csv', na.strings=c("","NA"))
```

# Basic Demographics

- Age and Sex

```{r}
#
df %>%  select(Q34) %>% mutate(Q34 = factor(Q34, levels=c(1:4), labels = c("Male","Female","Non-Binary/Other","Prefer Not to say"))) %>%
  tbl_summary(label = list(Q34 ~ "Sex")) # need to add labels

# age is not clean, need to go over, if not numeric then set as NA
df <- df %>% mutate (
  age = as.numeric(df$Q33)
)

ggplot(df, aes(x=age)) + geom_histogram(bins=10, fill = 'lightblue') +theme_minimal() + ggtitle("Age Histogram (Before omitting")

# Education
df %>%  select(Q32) %>% mutate(Q32 = factor(Q32, levels=c(1:6), labels = c("1","2","3","4", "5","6"))) %>%
  tbl_summary(label = list(Q32 ~ "Education")) # need to add labels
```

# Location of responders

```{r}
df %>%  drop_na(LocationLongitude) %>% mapview(xcol = "LocationLongitude", ycol = "LocationLatitude", crs = 4269,  grid = F)
```

# Attention Checks

Let's see how many failed the attention check

- Asking about Moon and Earth
- Asking about colors (say all)
- Asking about No. of traumas (say 5)

```{r}

df %>% select(Q65) %>% drop_na()  %>% tbl_summary()

```

Only one person failed attention check


# Sanity 

Lets just grab the dichotomous question (which is more central emotional pain or fear), and see if it correlates with the manual scale

```{r}
# 40  -dicho (1=pain, 2=fear), 67 - trauma reminder, 68 - emotional pain

df2 <- df %>% select(Q47, Q39_1, Q40_1)#$[2:nrow(df),c(9,40, 67, 68)]
# changing column names
colnames(df2)[1] = "dich"
colnames(df2)[2] = "fear"
colnames(df2)[3] = "pain"
df2$dich <- factor(df2$dich)
summary(df2)
df2 <- drop_na(df2) # 44 subjects

ggplot(df2, aes(x=dich, y=pain, group = dich)) + geom_boxplot() + theme_minimal() + ggtitle("Emotional pain as factor of the Dichotomous question")

ggplot(df2, aes(x=dich, y=fear, group = dich)) + geom_boxplot() + theme_minimal() + ggtitle("Fear as factor of the Dichotomous question")
summary(lm(fear ~ dich, data=df2))
```
## Calculate Total Scores

```{r}
# PCL items: Q2 - Q21
# PCL break: Q42 (fear/horror), Q43 (guilt/shame), Q44 (anger), Q45(blame yourself), Q46(Blame others)
# These will replace Q11 and Q12
# RTQ items: Q50_1 - Q50_10
# ASI items: Q51_1 - Q51_16
# GAD items: Q38_1 - Q38_7
# PHQ-9: Q37_1 - Q37_9
```

### PCL-5 Total Score
```{r}
df_2 <- df %>% 
  slice(-1) %>%
  mutate(across(Q2:Q21, as.numeric),
         across(Q50_1:Q50_10, as.numeric),
         across(Q37_1:Q37_9, as.numeric),
         across(Q38_1:Q38_7, as.numeric),
         across(Q51_1:Q51_16, as.numeric)) %>% 
  rowwise(ResponseId) %>%
  mutate(totalPCL = sum(c(Q2, Q3, Q4, Q5, Q6, Q7, Q8, Q9, Q10, Q11, Q12, Q13, Q14, Q15, Q16, Q17, Q18, Q19, Q20, Q21)),
         totalRTQ = sum(c(Q50_1,Q50_2, Q50_3, Q50_3, Q50_5, Q50_6, Q50_7, Q50_8, Q50_9, Q50_10)),
         totalPHQ = sum(Q37_1, Q37_2, Q37_3, Q37_4, Q37_5, Q37_6, Q37_7, Q37_8, Q37_9),
         totalGAD = sum(Q38_1, Q38_2, Q38_3, Q38_4, Q38_5, Q38_6, Q38_7),
         totalASI = sum(Q51_1, Q51_2, Q51_3, Q51_4, Q51_5, Q51_6, Q51_7, Q51_8, Q51_9, Q51_10, Q51_11, Q51_12, Q51_13, Q51_14, Q51_15, Q51_16))
 

hist(df_2$totalPCL)
hist(df_2$totalRTQ)
hist(df_2$totalPHQ)
hist(df_2$totalGAD)
hist(df_2$totalASI)

```

### Test histogram of RTQ within different cutoffs of PCL
```{r}

df_highP <- df_2 %>% filter(totalPCL>=28)
df_lowP <- df_2 %>% filter(totalPCL<28)

par(mfrow=c(2,1))
 
#Make the plot
par(mar=c(2,5,1,2))
hist(df_highP$totalRTQ , main="" , ylab="Frequency for high PCL", xlab="", xaxt="n", ylim=c(0,100), las=1 , col="slateblue1", breaks=10)
hist(df_lowP$totalRTQ, main="", ylab="Frequency for low PCL", xlab="RTQ-10 Score", ylim=c(100,0),las=1 , col="tomato3"  , breaks=10)

```

### Correlation between RTQ and PCL
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalPCL)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalRTQ)
```

Correlation of 0.66.


### Correlation between PCL and GAD
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalGAD)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalGAD)
```

### Correlation between PCL and ASI
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalASI)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalASI)
```


### Correlation between RTQ and ASI
```{r}
df_2 %>% ggplot(aes(x=totalRTQ, y=totalASI)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalRTQ, df_2$totalASI)
```

```{r LNM rename, echo=FALSE, message=TRUE, warning=FALSE}
df_factor <- df_2 %>% 
    rename(PCL1 = Q2,
         PCL2 = Q3,
         PCL3 = Q4,
         PCL4 = Q5,
         PCL5 = Q6,
         PCL6 = Q7,
         PCL7 = Q8,
         PCL8 = Q9,
         PCL9 = Q10,
         PCL10 = Q11,
         PCL11 = Q12,
         PCL12 = Q13,
         PCL13 = Q14,
         PCL14 = Q15,
         PCL15 = Q16,
         PCL16 = Q17,
         PCL17 = Q18,
         PCL18 = Q19,
         PCL19 = Q20,
         PCL20 = Q21)

```


```{r LNM 3 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Rename
# Factor structure
Latents_3_factor<-c("PCL","RTQ", "ASI")

# Variables
vars_3 <- c("PCL1", "PCL2", "PCL3", "PCL4", "PCL5", "PCL6", "PCL7", "PCL8", "PCL9", "PCL10", 
            "PCL11", "PCL12", "PCL13", "PCL14", "PCL15", "PCL16", "PCL17", "PCL18", "PCL19", "PCL20", 
            "Q50_1", "Q50_2", "Q50_3", "Q50_4", "Q50_5", "Q50_6", "Q50_7", "Q50_8", "Q50_9", "Q50_10", 
            "Q51_1", "Q51_2", "Q51_3", "Q51_4", "Q51_5", "Q51_6", "Q51_7", "Q51_8", "Q51_9", "Q51_10", 
            "Q51_11", "Q51_12", "Q51_13", "Q51_14", "Q51_15", "Q51_16")


# Individual factors
Lambda_3_factor <- matrix(0,46,3)
Lambda_3_factor[1:20,1] <- 1
Lambda_3_factor[21:30,2] <- 1
Lambda_3_factor[31:46,3] <- 1
```

Second, we define the alpha level and set the seed.
```{r LNM set alpha, echo=FALSE, message=TRUE, warning=FALSE}
alpha = 0.01
set.seed(NULL)
```

Third, we define the LNMs.
```{r LNM define model, echo=FALSE, message=TRUE, warning=FALSE}
# Define models
lnmMod_3_factor <-  lnm(df_factor, vars=vars_3,  lambda = Lambda_3_factor,  latents = Latents_3_factor, identification = "variance")
```

Fourth, we run the LNM.
```{r LNM run model, echo=FALSE, message=TRUE, warning=FALSE}
# Run & Remove non-sig latent edges:
lnmMod_3_prune <- lnmMod_3_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
```

### Results
Fit measures
```{r LNM fit, echo=FALSE, message=TRUE, warning=FALSE}
lnmMod_3_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
```

Plot
```{r LNM Plot, echo=FALSE, message=TRUE, warning=FALSE}
qgraph(lnmMod_3_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_3_factor,
       theme = "colorblind", vsize = 10)
```

















 8 factor models
```{r LNM 8 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Rename
# Factor structure
Latents_8_factor<-c("Re1","Re2", "Av", "Na", "An","Eb","Aa","Da")

# Variables
vars_8 = c("PCL1", "PCL2", "PCL3","PCL4","PCL5","PCL6","PCL7","PCL8" ,"PCL9",
        "PCL10","PCL11","PCL12","PCL13","PCL14","PCL15","PCL16","PCL17", "PCL18","PCL19","PCL20")

# Individual factors
Lambda_8_factor <- matrix(0,20,8)
Lambda_8_factor[1:3,1] <- 1
Lambda_8_factor[4:5,2] <- 1
Lambda_8_factor[6:7,3] <- 1
Lambda_8_factor[8:11,4] <- 1
Lambda_8_factor[12:14, 5] <- 1
Lambda_8_factor[15:16,6] <- 1
Lambda_8_factor[17:18,7] <- 1
Lambda_8_factor[19:20,8] <- 1
```

7 Factor Model
```{r LNM 7 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Factor structure
Latents_7_factor<-c("Re", "Av", "Na", "An","Eb","Aa","Da")

# Individual factors
Lambda_7_factor <- matrix(0,20,7)
Lambda_7_factor[1:5,1] <- 1
Lambda_7_factor[6:7,2] <- 1
Lambda_7_factor[8:11,3] <- 1
Lambda_7_factor[12:14,4] <- 1
Lambda_7_factor[15:16,5] <- 1
Lambda_7_factor[17:18,6] <- 1
Lambda_7_factor[19:20,7] <- 1
```

4 Factor DSM  Model
```{r LNM 5 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Factor structure
Latents_4_factor<-c("Re", "Av", "Mood", "Arousal")

# Individual factors
Lambda_4_factor <- matrix(0,20,4)
Lambda_4_factor[1:5,1] <- 1
Lambda_4_factor[6:7,2] <- 1
Lambda_4_factor[8:14,3] <- 1
Lambda_4_factor[15:20,4] <- 1
```

Second, we define the alpha level and set the seed.

Third, we define the LNMs.
```{r LNM define models, echo=FALSE, message=TRUE, warning=FALSE}
# Define models
lnmMod_8_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_8_factor,  latents = Latents_8_factor, identification = "variance")
lnmMod_7_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_7_factor,  latents = Latents_7_factor, identification = "variance")
lnmMod_4_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_4_factor,  latents = Latents_4_factor, identification = "variance")
```

Fourth, we run the LNM.
```{r LNM run models, echo=FALSE, message=TRUE, warning=FALSE}
# Run & Remove non-sig latent edges:
lnmMod_8_prune <- lnmMod_8_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
lnmMod_7_prune <- lnmMod_7_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
lnmMod_4_prune <- lnmMod_4_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
```

# Results
Fit measures
```{r LNM fit models, echo=FALSE, message=TRUE, warning=FALSE}
lnmMod_8_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
lnmMod_7_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
lnmMod_4_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
```

Plot
```{r LNM Plots, echo=FALSE, message=TRUE, warning=FALSE}
qgraph(lnmMod_8_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_8_factor,
       theme = "colorblind", vsize = 10)
qgraph(lnmMod_7_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_7_factor,
       theme = "colorblind", vsize = 10)
qgraph(lnmMod_4_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_4_factor,
       theme = "colorblind", vsize = 10)
```

## Network model of 8-factors and RTQ and ASI

```{r}
Latents_8_factor_ASI_RTQ<-c("Re1","Re2", "Av", "Na", "An","Eb","Aa","Da", "Rum", "Anx")

# Variables
vars_all = c("PCL1", "PCL2", "PCL3","PCL4","PCL5","PCL6","PCL7","PCL8" ,"PCL9",
        "PCL10","PCL11","PCL12","PCL13","PCL14","PCL15","PCL16","PCL17", "PCL18","PCL19","PCL20", 
        "Q50_1", "Q50_2", "Q50_3", "Q50_4", "Q50_5", "Q50_6", "Q50_7", "Q50_8", "Q50_9", "Q50_10", 
            "Q51_1", "Q51_2", "Q51_3", "Q51_4", "Q51_5", "Q51_6", "Q51_7", "Q51_8", "Q51_9", "Q51_10", 
            "Q51_11", "Q51_12", "Q51_13", "Q51_14", "Q51_15", "Q51_16")

# Individual factors
Lambda_10_factors <- matrix(0,46,10)
Lambda_10_factors[1:3,1] <- 1
Lambda_10_factors[4:5,2] <- 1
Lambda_10_factors[6:7,3] <- 1
Lambda_10_factors[8:11,4] <- 1
Lambda_10_factors[12:14, 5] <- 1
Lambda_10_factors[15:16,6] <- 1
Lambda_10_factors[17:18,7] <- 1
Lambda_10_factors[19:20,8] <- 1
Lambda_10_factors[21:30,9] <- 1
Lambda_10_factors[31:46,10] <- 1
```

```{r}
# define
lnmMod_10_factor <-  lnm(df_factor, vars=vars_all,  lambda = Lambda_10_factors,  latents = Latents_8_factor_ASI_RTQ, identification = "variance")

```

Prune and test
```{r}
lnmMod_10_prune <- lnmMod_10_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 

qgraph(lnmMod_10_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_8_factor_ASI_RTQ,
       theme = "colorblind", vsize = 10)

lnmMod_10_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]

```


Due to lack of power we will evaluate based on total score of each cluster

### Total score evaluation - using simple network analysis
- Not latent models

```{r}
# build cluster scores
df3 <- df_factor %>% mutate(
  RE1 = PCL1 + PCL2 + PCL3,
  RE2 = PCL4 + PCL5,
  Av = PCL6 + PCL7,
  Na = PCL8 + PCL9 + PCL10 + PCL11,
  An = PCL12 + PCL13 + PCL14,
  Eb = PCL15 + PCL16,
  Aa = PCL17 + PCL18,
  Da = PCL19 + PCL20,

)

# bootnet

df4 <- df3 %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalGAD) 

net <- estimateNetwork(df4[,2:11], "ggmModSelect")
plot(net)
```

Now with ASI:

```{r}
df5 <- df3 %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalASI)
netASI <-  estimateNetwork(df5[,2:11],default = "ggmModSelect") 
plot(netASI)
```

