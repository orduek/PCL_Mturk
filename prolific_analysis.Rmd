---
title: "Questionnaire Analysis"
author: "Or Duek & Tobias R. Spiller"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: yes

---


```{r, results='hide',  message=FALSE, warning=FALSE, include=FALSE}
# load libraries
require(tidyverse)
library(psych)
require(ggplot2)
require(bootnet)
require(qgraph)
require(psychonetrics)
library(cluster)


# map
require(sf)
require(mapview)

# tables
require(gtsummary)

# xls
library(readxl)
```

# Analysing Prolific Data

```{r}
# read data
df <- read.csv('Prolific_trauma-exp_only_PCL-V_Randomization.csv', na.strings=c("","NA"))
```

# Basic Demographics
Age and Sex
```{r}
#
df %>%  select(Q34) %>% mutate(Q34 = factor(Q34, levels=c(1:4), labels = c("Male","Female","Non-Binary/Other","Prefer Not to say"))) %>%
  tbl_summary(label = list(Q34 ~ "Sex")) # need to add labels

# age is not clean, need to go over, if not numeric then set as NA
df <- df %>% mutate (
  age = as.numeric(df$Q33)
)

ggplot(df, aes(x=age)) + geom_histogram(bins=10, fill = 'lightblue') +theme_minimal() + ggtitle("Age Histogram (Before omitting")

# Education
df %>%  select(Q32) %>% mutate(Q32 = factor(Q32, levels=c(1:7), labels = c("lessHighSchool","HighSchool_GED","College_nodegree",
                                                                           "technical_degree", "BA","MA/PhD", "Prefer_not"))) %>%
  tbl_summary(label = list(Q32 ~ "Education")) # need to add labels
```

# Location of responders
```{r}
df %>%  drop_na(LocationLongitude) %>% mapview(xcol = "LocationLongitude", ycol = "LocationLatitude", crs = 4269,  grid = F)
```

# Attention Checks
Let's see how many failed the attention check
- Asking about Moon and Earth
- Asking about colors (say all)
- Asking about No. of traumas (say 5)

```{r}

df %>% select(Q65) %>% drop_na()  %>% tbl_summary()

```
Only one person failed attention check


# Sanity 
Lets just grab the dichotomous question (which is more central emotional pain or fear), and see if it correlates with the manual scale
```{r}
# 40  -dicho (1=pain, 2=fear), 67 - trauma reminder, 68 - emotional pain

df2 <- df %>% select(Q47, Q39_1, Q40_1)#$[2:nrow(df),c(9,40, 67, 68)]
# changing column names
colnames(df2)[1] = "dich"
colnames(df2)[2] = "fear"
colnames(df2)[3] = "pain"
df2$dich <- factor(df2$dich)
summary(df2)
df2 <- drop_na(df2) # 44 subjects

ggplot(df2, aes(x=dich, y=pain, group = dich)) + geom_boxplot() + theme_minimal() + ggtitle("Emotional pain as factor of the Dichotomous question")

ggplot(df2, aes(x=dich, y=fear, group = dich)) + geom_boxplot() + theme_minimal() + ggtitle("Fear as factor of the Dichotomous question")
summary(lm(fear ~ dich, data=df2))
```

## Calculate Total Scores
```{r}
df_2 <- df %>% 
  slice(-1) %>%
  mutate(across(Q2:Q21, as.numeric),
         across(Q50_1:Q50_10, as.numeric),
         across(Q37_1:Q37_9, as.numeric),
         across(Q38_1:Q38_7, as.numeric),
         across(Q51_1:Q51_16, as.numeric)) %>% 
  rowwise(ResponseId) %>%
  mutate(totalPCL = sum(c(Q2, Q3, Q4, Q5, Q6, Q7, Q8, Q9, Q10, Q11, Q12, Q13, Q14, Q15, Q16, Q17, Q18, Q19, Q20, Q21)),
         totalRTQ = sum(c(Q50_1,Q50_2, Q50_3, Q50_3, Q50_5, Q50_6, Q50_7, Q50_8, Q50_9, Q50_10)),
         totalPHQ = sum(Q37_1, Q37_2, Q37_3, Q37_4, Q37_5, Q37_6, Q37_7, Q37_8, Q37_9),
         totalGAD = sum(Q38_1, Q38_2, Q38_3, Q38_4, Q38_5, Q38_6, Q38_7),
         totalASI = sum(Q51_1, Q51_2, Q51_3, Q51_4, Q51_5, Q51_6, Q51_7, Q51_8, Q51_9, Q51_10, Q51_11, Q51_12, Q51_13, Q51_14, Q51_15, Q51_16))
 

hist(df_2$totalPCL)
hist(df_2$totalRTQ)
hist(df_2$totalPHQ)
hist(df_2$totalGAD)
hist(df_2$totalASI)

```

### Test histogram of RTQ within different cutoffs of PCL
```{r}

df_highP <- df_2 %>% filter(totalPCL>=28)
df_lowP <- df_2 %>% filter(totalPCL<28)

par(mfrow=c(2,1))
 
#Make the plot
par(mar=c(2,5,1,2))
hist(df_highP$totalRTQ , main="" , ylab="Frequency for high PCL", xlab="", xaxt="n", ylim=c(0,100), las=1 , col="slateblue1", breaks=10)
hist(df_lowP$totalRTQ, main="", ylab="Frequency for low PCL", xlab="RTQ-10 Score", ylim=c(100,0),las=1 , col="tomato3"  , breaks=10)

```

### Correlation between RTQ and PCL
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalPCL)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalRTQ)
```

### Correlation between PCL and GAD
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalGAD)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalGAD)
```

### Correlation between PCL and ASI
```{r}
df_2 <- df_2 %>% mutate(
  pcl_H_L = case_when(totalPCL>=28 ~ "HighPCL",
                      totalPCL<28 ~ "LowPCL")
)
df_2 %>% drop_na(totalPCL) %>% ggplot(aes(x=totalRTQ, y=totalASI)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalPCL, df_2$totalASI)
```

### Correlation between RTQ and ASI
```{r}
df_2 %>% ggplot(aes(x=totalRTQ, y=totalASI)) + geom_point(aes(color=pcl_H_L)) + geom_smooth(method='lm') + theme_minimal()

cor.test(df_2$totalRTQ, df_2$totalASI)
```



## OLD LNM ANALYSIS
```{r LNM rename, echo=FALSE, message=TRUE, warning=FALSE}
df_factor <- df_2 %>% 
    rename(PCL1 = Q2,
         PCL2 = Q3,
         PCL3 = Q4,
         PCL4 = Q5,
         PCL5 = Q6,
         PCL6 = Q7,
         PCL7 = Q8,
         PCL8 = Q9,
         PCL9 = Q10,
         PCL10 = Q11,
         PCL11 = Q12,
         PCL12 = Q13,
         PCL13 = Q14,
         PCL14 = Q15,
         PCL15 = Q16,
         PCL16 = Q17,
         PCL17 = Q18,
         PCL18 = Q19,
         PCL19 = Q20,
         PCL20 = Q21)

```


```{r LNM 3 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Rename
# Factor structure
Latents_3_factor<-c("PCL","RTQ", "ASI")

# Variables
vars_3 <- c("PCL1", "PCL2", "PCL3", "PCL4", "PCL5", "PCL6", "PCL7", "PCL8", "PCL9", "PCL10", 
            "PCL11", "PCL12", "PCL13", "PCL14", "PCL15", "PCL16", "PCL17", "PCL18", "PCL19", "PCL20", 
            "Q50_1", "Q50_2", "Q50_3", "Q50_4", "Q50_5", "Q50_6", "Q50_7", "Q50_8", "Q50_9", "Q50_10", 
            "Q51_1", "Q51_2", "Q51_3", "Q51_4", "Q51_5", "Q51_6", "Q51_7", "Q51_8", "Q51_9", "Q51_10", 
            "Q51_11", "Q51_12", "Q51_13", "Q51_14", "Q51_15", "Q51_16")


# Individual factors
Lambda_3_factor <- matrix(0,46,3)
Lambda_3_factor[1:20,1] <- 1
Lambda_3_factor[21:30,2] <- 1
Lambda_3_factor[31:46,3] <- 1
```

Second, we define the alpha level and set the seed.
```{r LNM set alpha, echo=FALSE, message=TRUE, warning=FALSE}
alpha = 0.01
set.seed(NULL)
```

Third, we define the LNMs.
```{r LNM define model, echo=FALSE, message=TRUE, warning=FALSE}
# Define models
lnmMod_3_factor <-  lnm(df_factor, vars=vars_3,  lambda = Lambda_3_factor,  latents = Latents_3_factor, identification = "variance")
```

Fourth, we run the LNM.
```{r LNM run model, echo=FALSE, message=TRUE, warning=FALSE}
# Run & Remove non-sig latent edges:
lnmMod_3_prune <- lnmMod_3_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
```

Results
Fit measures
```{r LNM fit, echo=FALSE, message=TRUE, warning=FALSE}
lnmMod_3_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
```

Plot
```{r LNM Plot, echo=FALSE, message=TRUE, warning=FALSE}
qgraph(lnmMod_3_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_3_factor,
       theme = "colorblind", vsize = 10)
```


 8 factor models
```{r LNM 8 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Rename
# Factor structure
Latents_8_factor<-c("Re1","Re2", "Av", "Na", "An","Eb","Aa","Da")

# Variables
vars_8 = c("PCL1", "PCL2", "PCL3","PCL4","PCL5","PCL6","PCL7","PCL8" ,"PCL9",
        "PCL10","PCL11","PCL12","PCL13","PCL14","PCL15","PCL16","PCL17", "PCL18","PCL19","PCL20")

# Individual factors
Lambda_8_factor <- matrix(0,20,8)
Lambda_8_factor[1:3,1] <- 1
Lambda_8_factor[4:5,2] <- 1
Lambda_8_factor[6:7,3] <- 1
Lambda_8_factor[8:11,4] <- 1
Lambda_8_factor[12:14, 5] <- 1
Lambda_8_factor[15:16,6] <- 1
Lambda_8_factor[17:18,7] <- 1
Lambda_8_factor[19:20,8] <- 1
```

7 Factor Model
```{r LNM 7 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Factor structure
Latents_7_factor<-c("Re", "Av", "Na", "An","Eb","Aa","Da")

# Individual factors
Lambda_7_factor <- matrix(0,20,7)
Lambda_7_factor[1:5,1] <- 1
Lambda_7_factor[6:7,2] <- 1
Lambda_7_factor[8:11,3] <- 1
Lambda_7_factor[12:14,4] <- 1
Lambda_7_factor[15:16,5] <- 1
Lambda_7_factor[17:18,6] <- 1
Lambda_7_factor[19:20,7] <- 1
```

4 Factor DSM  Model
```{r LNM 5 Factor, echo=FALSE, message=TRUE, warning=FALSE}
# Factor structure
Latents_4_factor<-c("Re", "Av", "Mood", "Arousal")

# Individual factors
Lambda_4_factor <- matrix(0,20,4)
Lambda_4_factor[1:5,1] <- 1
Lambda_4_factor[6:7,2] <- 1
Lambda_4_factor[8:14,3] <- 1
Lambda_4_factor[15:20,4] <- 1
```

Second, we define the alpha level and set the seed.

Third, we define the LNMs.
```{r LNM define models, echo=FALSE, message=TRUE, warning=FALSE}
# Define models
lnmMod_8_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_8_factor,  latents = Latents_8_factor, identification = "variance")
lnmMod_7_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_7_factor,  latents = Latents_7_factor, identification = "variance")
lnmMod_4_factor <-  lnm(df_factor, vars=vars_8,  lambda = Lambda_4_factor,  latents = Latents_4_factor, identification = "variance")
```

Fourth, we run the LNM.
```{r LNM run models, echo=FALSE, message=TRUE, warning=FALSE}
# Run & Remove non-sig latent edges:
lnmMod_8_prune <- lnmMod_8_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
lnmMod_7_prune <- lnmMod_7_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
lnmMod_4_prune <- lnmMod_4_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 
```


Fit measures
```{r LNM fit models, echo=FALSE, message=TRUE, warning=FALSE}
lnmMod_8_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
lnmMod_7_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
lnmMod_4_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
```

Plot
```{r LNM Plots, echo=FALSE, message=TRUE, warning=FALSE}
qgraph(lnmMod_8_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_8_factor,
       theme = "colorblind", vsize = 10)
qgraph(lnmMod_7_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_7_factor,
       theme = "colorblind", vsize = 10)
qgraph(lnmMod_4_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_4_factor,
       theme = "colorblind", vsize = 10)
```




### Total score evaluation - using simple network analysis
- Not latent models
```{r}
# build cluster scores
df3 <- df_factor %>% mutate(
  RE1 = PCL1 + PCL2 + PCL3,
  RE2 = PCL4 + PCL5,
  Av = PCL6 + PCL7,
  Na = PCL8 + PCL9 + PCL10 + PCL11,
  An = PCL12 + PCL13 + PCL14,
  Eb = PCL15 + PCL16,
  Aa = PCL17 + PCL18,
  Da = PCL19 + PCL20,

)

# bootnet

df4 <- df3 %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalGAD) 

net <- estimateNetwork(df4[,2:11], "ggmModSelect")
plot(net)
```

Now with ASI:

```{r}
df5 <- df3 %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalASI)
netASI <-  estimateNetwork(df5[,2:11],default = "ggmModSelect") 
plot(netASI)
```

## Seperating those who chose emotional Pain and those who said fearful reaction
First, how many in each group
```{r}
df %>% mutate(Q47 = factor(Q47, levels=c(1:2), labels = c("Emotional Pain","Fearful Reaction"))) %>% select(Q47)  %>%
  tbl_summary(label = list(Q47 ~ "Education"))
  

```
### Emotional Pain
```{r}
# emotional pain first
df6 <- df3 %>% filter(Q47==1) %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalGAD)
net_Em_Pain <-  estimateNetwork(df6[,2:11],default = "ggmModSelect") 
plot(net_Em_Pain)
```
### Fearful Reaction
```{r}
# emotional pain first
df7 <- df3 %>% filter(Q47==2) %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, totalRTQ, totalGAD)
net_Fear <-  estimateNetwork(df7[,2:11],default = "ggmModSelect") 
plot(net_Fear)
```






# B & I
## 1. Stratification
Individual items
Q42 Having strong negative feelings such as fear or horror?	
Q43 Having strong negative feelings such as guilt, or shame?	
Q44 Having strong negative feelings of anger?

Select new items
```{r}
df_extra <- df_2 %>% 
  ungroup %>% 
  dplyr::select(Q42:Q44,
                Q2:Q21, #PCL
                Q37_1:Q37_9, #PHQ
                Q38_1:Q38_7, #GAD
                Q51_1:Q51_16, #ASI
                totalPCL, totalPHQ, totalGAD, totalASI, totalRTQ) %>% 
  mutate_all(as.numeric) %>% 
  na.omit()
```

Assess the correlation between the different emotions
```{r}
df_extra_4 <- df_extra %>% 
  dplyr::select(Q42:Q44)

cor_matrix <- cor(df_extra_4)
round(cor_matrix, 2)

# Create a data frame from the matrix
df_plot <- as.data.frame(df_extra_4)

# Create a jitter plot matrix with correlation line
ggplot(df_plot, aes(x = Q42, y = Q43)) + 
  geom_jitter() +
  stat_smooth(method = "lm", se = FALSE, color = "red") + # Add a linear regression line
  labs(x = "Q42", y = "Q43") +
  theme_classic()

ggplot(df_plot, aes(x = Q42, y = Q44)) + 
  geom_jitter() +
  stat_smooth(method = "lm", se = FALSE, color = "red") + # Add a linear regression line
  labs(x = "Q42", y = "Q44") +
  theme_classic()

ggplot(df_plot, aes(x = Q43, y = Q44)) + 
  geom_jitter() +
  stat_smooth(method = "lm", se = FALSE, color = "red") + # Add a linear regression line
  labs(x = "Q43", y = "Q44") +
  theme_classic()
```

### 1.1 PTSD Internal structre
How do emotion items relate to the other PTSD items? 
Correlation Analysis
```{r}
df_extra_2 <- df_extra %>%   
  select(Q2:Q21, Q42, Q43, Q44) 

cor_matrix <- cor(df_extra_2, use = "pairwise.complete.obs")
print(cor_matrix, digits = 2)
```
Network Analysis
```{r}
net_PCL_new_items <- estimateNetwork(df_extra_2, "ggmModSelect")
plot(net_PCL_new_items, layout = "circle")
```

Exploratory Factor analysis assuming a 4 factor structure
- the new items separate nicely
- Replicate DSM-5 model (more or less)
```{r}
# Perform EFA using principal axis factoring (PAF) with oblimin rotation
efa_result <- fa(cor_matrix, nfactors = 4, rotate = "oblimin", fm = "pa", 
                 missing = "pairwise", scores = "regression")

# Print the factor loadings
print(efa_result$loadings, digits = 2, cutoff = 0.4)
```

Assess how the are related to the 8-factor model [not run because it exceeds running time]
```{r eval=FALSE, include=FALSE}
# Define
Latents_8_factor_new_items<-c("Re1","Re2", "Av", "Na", "An","Eb","Aa", "Da", "Fear", "Shame", "Anger")

# Variables
vars_all = c("Q2", "Q3", "Q4","Q5","Q6","Q7","Q8","Q9" ,"Q10",
        "Q11","Q12","Q13","Q14","Q15","Q16","Q17","Q18", "Q19","Q20","Q21", "Q42", "Q43", "Q44")

# Individual factors
Lambda_10_factors <- matrix(0,23,11)
Lambda_10_factors[1:3,1] <- 1
Lambda_10_factors[4:5,2] <- 1
Lambda_10_factors[6:7,3] <- 1
Lambda_10_factors[8:11,4] <- 1
Lambda_10_factors[12:14, 5] <- 1
Lambda_10_factors[15:16,6] <- 1
Lambda_10_factors[17:18,7] <- 1
Lambda_10_factors[19:20,8] <- 1
Lambda_10_factors[21,9] <- 1
Lambda_10_factors[22,10] <- 1
Lambda_10_factors[23,11] <- 1

# Run
lnmMod_10_factor <-  lnm(df_extra_2, vars=vars_all,  lambda = Lambda_10_factors,  latents = Latents_8_factor_new_items, identification = "variance")

# Prune
lnmMod_10_prune <- lnmMod_10_factor %>% runmodel %>% psychonetrics::prune(alpha = alpha) 

qgraph(lnmMod_10_prune@modelmatrices[[1]]$omega_zeta, labels = Latents_8_factor_new_items,
       theme = "colorblind", vsize = 10)

# Results
lnmMod_10_prune@fitmeasures[c("chisq","pvalue","df", "rmsea","cfi", "tli", "aic.ll", "bic")]
```

Using ordinary networks
- not using LNM (due to power)
- need to update the code
```{r}
# build factors scores
df_extra_NW <- df_factor %>% 
  mutate(
  RE1 = PCL1 + PCL2 + PCL3,
  RE2 = PCL4 + PCL5,
  Av = PCL6 + PCL7,
  Na = PCL8 + PCL9 + PCL10 + PCL11,
  An = PCL12 + PCL13 + PCL14,
  Eb = PCL15 + PCL16,
  Aa = PCL17 + PCL18,
  Da = PCL19 + PCL20) %>% 
  ungroup() %>% 
  mutate_all(as.numeric)

# bootnet
df_extra_NW_1 <- df_extra_NW %>% select(RE1, RE2, Av, Na, An, Eb, Aa, Da, Q42, Q43, Q44)  %>% 
  drop_na()

net <- estimateNetwork(df_extra_NW_1, "ggmModSelect")
plot(net, layout = "circle")

```


## 1.2. EXTERNAL
Full data matrix for the emotions and the scale total scores
```{r}
df_extra_5 <- df_extra %>% 
  dplyr::select(Q42:Q44, totalPCL, totalPHQ, totalGAD, totalASI, totalRTQ)

cor_matrix <- cor(df_extra_5)
round(cor_matrix, 2)
```


Adjusting for PTSD overall
1. Rumination
```{r}
model <- lm(totalRTQ ~ totalPCL + Q42 +Q43 +Q44, data = df_extra_5)

# Print the model summary
summary(model)
```

2. Anxiety - ASI
```{r}
model <- lm(totalASI ~ totalPCL + Q42 +Q43 +Q44, data = df_extra_5)

# Print the model summary
summary(model)
```

3. Anxiety - GAD
```{r}
model <- lm(totalGAD ~ totalPCL + Q42 +Q43 +Q44, data = df_extra_5)

# Print the model summary
summary(model)
```

4. Depression - PHQ
```{r}
model <- lm(totalPHQ ~ totalPCL + Q42 +Q43 +Q44, data = df_extra_5)

# Print the model summary
summary(model)
```

```{r}

# bootnet
df_extra_NW_3 <- df_extra_5 %>%   
  select(totalPCL, totalPHQ, totalGAD, totalASI, totalRTQ, Q42, Q43, Q44) 

net <- estimateNetwork(df_extra_NW_3, "ggmModSelect")
plot(net, layout = "circle")

```


### 2. INDIVIDUALS
### 2.1 Internal
#### Categorical
Calculate how many individuals report high (>=2 on a 0-4 scale) fear, shame, and anger
```{r}
df_extra_2 <- df_extra %>% 
  ungroup() %>% 
  dplyr::select(-ResponseId) %>% 
  mutate_all(as.numeric)

# Calculate median and quartiles of Q42, Q43, and Q44
df_extra_2 %>%
  dplyr::select(Q42:Q44) %>% 
  summarise_at(vars(Q42:Q44), list(median = median, q25 = quantile, q75 = quantile), probs = c(0.25, 0.75)) %>%
  print()

# Create new variables indicating low or high scores for Q42, Q43, and Q44
df_extra_2 <- df_extra_2 %>%
  mutate(Q42_low_high = ifelse(Q42 < 3, "low", "high"),
         Q43_low_high = ifelse(Q43 < 3, "low", "high"),
         Q44_low_high = ifelse(Q44 < 3, "low", "high"))

# Reshape the data
df_gather <- df_extra_2 %>%
  select(Q42_low_high, Q43_low_high, Q44_low_high) %>%
  gather() %>%
  mutate(variable = sub("_low_high", "", key))

# Calculate the summary statistics
df_summary <- df_gather %>%
  group_by(variable, value) %>%
  summarise(n = n(), percentage = n()/nrow(df_extra)*100)

# Print the summary statistics
print(df_summary)
```
The distribution is not even. More individuals report high shame than fear or anger. 


Next, we test how many individuals with high fear report high/low shame or high/low anger. We do this for all three emotions.
```{r}
# Calculate the number and percentage of individuals who are high or low on other variables within the Q42 high and low subsets
df_extra_2 %>%
  group_by(Q42_low_high) %>%
  summarise(Q43_high = sum(Q43 >= 3),
            Q43_low = sum(Q43 < 3),
            Q44_high = sum(Q44 >= 3),
            Q44_low = sum(Q44 < 3),
            percentage_Q43_high = Q43_high/n()*100,
            percentage_Q43_low = Q43_low/n()*100,
            percentage_Q44_high = Q44_high/n()*100,
            percentage_Q44_low = Q44_low/n()*100) %>%
  print()

df_extra_2 %>%
  group_by(Q43_low_high) %>%
  summarise(Q42_high = sum(Q42 >= 3),
            Q42_low = sum(Q42 < 3),
            Q44_high = sum(Q44 >= 3),
            Q44_low = sum(Q44 < 3),
            percentage_Q42_high = Q42_high/n()*100,
            percentage_Q42_low = Q42_low/n()*100,
            percentage_Q44_high = Q44_high/n()*100,
            percentage_Q44_low = Q44_low/n()*100) %>%
  print()


df_extra_2 %>%
  group_by(Q44_low_high) %>%
  summarise(Q42_high = sum(Q42 >= 3),
            Q42_low = sum(Q42 < 3),
            Q43_high = sum(Q43 >= 3),
            Q43_low = sum(Q43 < 3),
            percentage_Q42_high = Q42_high/n()*100,
            percentage_Q42_low = Q42_low/n()*100,
            percentage_Q43_high = Q43_high/n()*100,
            percentage_Q43_low = Q43_low/n()*100) %>%
  print()
```
There are relevant differences between individuals with high fear or high shame. 

Next, we want to assess, whether individuals who have predomninately fear vs shame do report differences in their levels of psychopathology (i.e., can we separate two subgroups based on fear vs shame).
```{r}
# Add a variable indicating two groups based on Q42 and Q43
df_extra_2 <- df_extra_2 %>%
  mutate(Q42_Q43_group = ifelse(Q42_low_high == "high" & Q43_low_high == "low", "Q42_high_Q43_low",
                                ifelse(Q42_low_high == "low" & Q43_low_high == "high", "Q42_low_Q43_high", NA)))

# Summarize the mean and standard deviation (or median) of totalPCL, totalPHQ, totalGAD, totalASI, and totalRTQ by Q42_Q43_group
df_extra_2 %>%
  group_by(Q42_Q43_group) %>%
  summarise(mean_totalPCL = mean(totalPCL),
            sd_totalPCL = sd(totalPCL),
            median_totalPCL = median(totalPCL),
            mean_totalPHQ = mean(totalPHQ),
            sd_totalPHQ = sd(totalPHQ),
            median_totalPHQ = median(totalPHQ),
            mean_totalGAD = mean(totalGAD),
            sd_totalGAD = sd(totalGAD),
            median_totalGAD = median(totalGAD),
            mean_totalASI = mean(totalASI),
            sd_totalASI = sd(totalASI),
            median_totalASI = median(totalASI),
            mean_totalRTQ = mean(totalRTQ),
            sd_totalRTQ = sd(totalRTQ),
            median_totalRTQ = median(totalRTQ))
```
There are no relevant differences.

### Cluster Analysis
We use cluster analysis to check for subgroups. We define three clusters (due to three emotions). First, we use the three emotions and all relevant constructs (PCL, RTW, GAD, ASI, PHQ)
```{r}
# Load the necessary packages
library(psych)

# Select the relevant columns from the dataframe
df_subset <- df_extra_factor

# Use hierarchical clustering to determine the number of clusters
fviz_nbclust(df_subset, hcut, method = "wss", k.max = 10)

# Perform K-means clustering with the recommended number of clusters
cluster_result <- kmeans(df_subset, centers = 3)

# Print the cluster centers
print(cluster_result$centers)

# Add cluster assignments to the original dataframe
df_clusters <- df_extra_factor %>%
  mutate(cluster = cluster_result$cluster)

# Summarize the cluster assignments by variable
df_summary <- df_clusters %>%
  group_by(cluster) %>%
  summarise_all(funs(mean))
print(df_summary)
```
The separation is along severity and not different symptoms/psychopathologies.

Focusing on PTSD only.
```{r}
# Select the relevant columns from the dataframe
df_subset <- df_extra %>% 
  dplyr::select(totalPCL, Q42,Q43, Q44) %>% 
  filter(totalPCL >= 33) %>% 
  ungroup() %>% 
  mutate_all(as.numeric)

# Check for missing values
sum(is.na(df_subset))

# Standardize the data
df_subset_std <- scale(df_subset)

# Perform clustering using CLARA algorithm
clara_result <- clara(df_subset_std, k = 3, metric = "euclidean", samples = 10)

# Add cluster assignments to the original dataframe
df_clusters <- df_subset %>%
  mutate(cluster = clara_result$clustering)

# Summarize the cluster assignments by variable
df_summary <- df_clusters %>%
  group_by(cluster) %>%
  summarise_all(funs(mean))
print(df_summary)
```
Still based on severity.

Could use PCA....results are still based on severity.
